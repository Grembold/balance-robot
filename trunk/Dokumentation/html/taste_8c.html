<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>nBot: taste.c-Dateireferenz</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Erzeugt von Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Hauptseite</span></a></li>
    <li><a href="annotated.html"><span>Datenstrukturen</span></a></li>
    <li class="current"><a href="files.html"><span>Dateien</span></a></li>
    <li><a href="dirs.html"><span>Verzeichnisse</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>Auflistung&nbsp;der&nbsp;Dateien</span></a></li>
    <li><a href="globals.html"><span>Datei-Elemente</span></a></li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_6bb2651bc0a152aa2f3f5a312f6d27ea.html">nbot_lib</a></div>
<h1>taste.c-Dateireferenz</h1>Bis zu 8 Tasten entprellen, mit gedrückt halten und wiederholungs Funktion. <a href="#_details">Mehr ...</a>
<p>
<code>#include &lt;avr/io.h&gt;</code><br>
<code>#include &quot;<a class="el" href="taste_8h-source.html">taste.h</a>&quot;</code><br>

<p>
Include-AbhÃ¤ngigkeitsdiagramm fÃ¼r taste.c:<p><center><img src="taste_8c__incl.png" border="0" usemap="#taste.c_map" alt=""></center>
<map name="taste.c_map">
<area shape="rect" title="Bis zu 8 Tasten entprellen, mit gedrückt halten und wiederholungs Funktion." alt="" coords="117,5,184,32"><area shape="rect" href="taste_8h.html" title="Bis zu 8 Tasten entprellen, mit gedrückt halten und wiederholungs Funktion." alt="" coords="119,56,183,83"></map>

<p>
<a href="taste_8c-source.html">gehe zum Quellcode dieser Datei</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Funktionen</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taste_8c.html#3c812199e970c6e24569b04f9a827c34">tasten</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Tasten auf zusandswechsel überprüfen Die Funktion <a class="el" href="taste_8c.html#3c812199e970c6e24569b04f9a827c34" title="Tasten auf zusandswechsel überprüfen Die Funktion tasten() sollte etwas alle 4ms...">tasten()</a> sollte etwas alle 4ms aufgerufen werden.  <a href="#3c812199e970c6e24569b04f9a827c34"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taste_8c.html#e620d6d1b52fb6a8f948723a6f8726d0">get_key_press</a> (char key_mask)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Überprüft, ob eine Taste betätigt worden ist.<br>
 Jede gedrückte Taste wird nur einmal gemeldet.  <a href="#e620d6d1b52fb6a8f948723a6f8726d0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taste_8c.html#31f3340ee7b1ffc380535d385834bdc4">get_key_rpt</a> (char key_mask)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Überprüft, ob eine Taste lang genug betätigt worden ist, daß die tastenwiederholungs Funktion eintritt. Nach einer kleinen Verzögerung wird die gedrückte Taste regelmässig als erneut betätigt Makiert. Diese simuliert dem Benutzer ein wiederholendes drücken und loslassen der Taste.  <a href="#31f3340ee7b1ffc380535d385834bdc4"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Variablen</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="5fb52792292a654fc6abd084c2af0065"></a><!-- doxytag: member="taste.c::key_state" ref="5fb52792292a654fc6abd084c2af0065" args="" -->
volatile char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taste_8c.html#5fb52792292a654fc6abd084c2af0065">key_state</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="3b45ef9bac4b1568ff5f0cf5183616d0"></a><!-- doxytag: member="taste.c::key_press" ref="3b45ef9bac4b1568ff5f0cf5183616d0" args="" -->
volatile char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taste_8c.html#3b45ef9bac4b1568ff5f0cf5183616d0">key_press</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="a6d9a7a62a27dc6981cd6aeaf85a257c"></a><!-- doxytag: member="taste.c::key_rpt" ref="a6d9a7a62a27dc6981cd6aeaf85a257c" args="" -->
volatile char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="taste_8c.html#a6d9a7a62a27dc6981cd6aeaf85a257c">key_rpt</a></td></tr>

</table>
<hr><a name="_details"></a><h2>AusfÃ¼hrliche Beschreibung</h2>
Bis zu 8 Tasten entprellen, mit gedrückt halten und wiederholungs Funktion. 
<p>
Es werden 4 gleiche Zustände hintereinander benötigt, um als gültiges Drücken oder Loslassen erkannt zu werden. Dadurch hat sich die Ausführungszeit von 10 auf 12 Zyklen verlängert.<p>
<dl class="user" compact><dt><b>Funktionsweise:</b></dt><dd>Die Bits der Register CT0, CT1 bilden für jede Taste einen Zähler 0..3. Ist der Tastenzustand mit dem entprellten Zustand identisch, wird dieser 2-Bit Zähler permanent zurückgesetzt.<br>
<br>
 Nur wenn also 4-mal hintereinander der entgegengesetzte Tastenpegel anliegt, kann dieser Zähler einmal rum zählen (= 4 Zustände 0..3) und wenn dann immer noch der entgegengesetzte Tastenpegel anliegt, wird er von dem entprellten Register (key_state) übernommen.<br>
 Da die Tasten low-activ sind, bedeutet dort eine 1 = Taste gedrückt.</dd></dl>
<dl class="see" compact><dt><b>Siehe auch:</b></dt><dd><a class="el" href="timer_8c.html" title="Zeit-, Delay- und Entprell Funktionen.">timer.c</a></dd></dl>
<dl class="version" compact><dt><b>Version:</b></dt><dd>V001 - 31.12.2005 - Peter Dannegger<br>
 Created <a href="http://www.mikrocontroller.net/attachment.php/252480/C_TAST.C">http://www.mikrocontroller.net/attachment.php/252480/C_TAST.C</a><br>
 <p>
V001 - 25.02.2007 - Olaf Petersen<br>
 Dokumentiert<br>
 Global Interrupt Flag wird nun auf den Ursprünglichen Wert gestzt<br>
</dd></dl>
<dl class="user" compact><dt><b>Beispiel:</b></dt><dd>(Nur zur Demonstration der Parameter/Returnwerte) <div class="fragment"><pre class="fragment"><span class="preprocessor"> #define TASTE0 PA0     // PiN der Taste 0</span>
<span class="preprocessor"></span><span class="preprocessor"> #define TASTE1 PA1     // PiN der Taste 1</span>
<span class="preprocessor"></span><span class="preprocessor"> #define TASTE2 PA2     // PiN der Taste 2      </span>
<span class="preprocessor"></span>
 <span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) 
 { 
   DDRA &amp;=~((1&lt;&lt;TASTE0)|(1&lt;&lt;TASTE1)|(1&lt;&lt;TASTE2));  <span class="comment">// Tasten als Eingänge</span>
   PORTA |=(1&lt;&lt;TASTE0)|(1&lt;&lt;TASTE1)|(1&lt;&lt;TASTE2);    <span class="comment">// pullup aktivieren</span>
   timer0_init();                                  <span class="comment">// timer initialisieren</span>

   <span class="keywordflow">while</span>(1) 
   { 
     <span class="comment">// druecke Taste 0</span>
     <span class="keywordflow">if</span>( <a class="code" href="taste_8c.html#e620d6d1b52fb6a8f948723a6f8726d0" title="Überprüft, ob eine Taste betätigt worden ist.  Jede gedrückte Taste wird nur einmal...">get_key_press</a>( 1&lt;&lt;TAST0))
     {
       <span class="comment">//TO DO</span>
     }
     <span class="comment">// repeat on long press:</span>
     <span class="keywordflow">if</span>( <a class="code" href="taste_8c.html#e620d6d1b52fb6a8f948723a6f8726d0" title="Überprüft, ob eine Taste betätigt worden ist.  Jede gedrückte Taste wird nur einmal...">get_key_press</a>( 1&lt;&lt;TASTE1) || <a class="code" href="taste_8c.html#31f3340ee7b1ffc380535d385834bdc4" title="Überprüft, ob eine Taste lang genug betätigt worden ist, daß die tastenwiederholungs...">get_key_rpt</a>( 1&lt;&lt;TASTE1 ))
     {
       <span class="comment">//TO DO</span>
     }
   }
 }
</pre></div> </dd></dl>

<p>
Definiert in Datei <a class="el" href="taste_8c-source.html">taste.c</a>.<hr><h2>Dokumentation der Funktionen</h2>
<a class="anchor" name="e620d6d1b52fb6a8f948723a6f8726d0"></a><!-- doxytag: member="taste.c::get_key_press" ref="e620d6d1b52fb6a8f948723a6f8726d0" args="(char key_mask)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char get_key_press           </td>
          <td>(</td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>key_mask</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Überprüft, ob eine Taste betätigt worden ist.<br>
 Jede gedrückte Taste wird nur einmal gemeldet. 
<p>
<dl compact><dt><b>Parameter:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>key_mask</em>&nbsp;</td><td>Maske der zu Überprüfenden Tasten.</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>RÃ¼ckgabe:</b></dt><dd>Wurde die Makierte Taste betätigt steht an entsprechender Stelle eine 1. </dd></dl>

<p>
Definiert in Zeile <a class="el" href="taste_8c-source.html#l00118">118</a> der Datei <a class="el" href="taste_8c-source.html">taste.c</a>.<div class="fragment"><pre class="fragment"><a name="l00119"></a>00119 {
<a name="l00120"></a>00120   uint8_t tmp_sreg;
<a name="l00121"></a>00121   tmp_sreg = SREG;
<a name="l00122"></a>00122   cli();
<a name="l00123"></a>00123   key_mask &amp;= <a class="code" href="taste_8c.html#3b45ef9bac4b1568ff5f0cf5183616d0">key_press</a>;                        <span class="comment">// read key(s)</span>
<a name="l00124"></a>00124   <a class="code" href="taste_8c.html#3b45ef9bac4b1568ff5f0cf5183616d0">key_press</a> ^= key_mask;                        <span class="comment">// clear key(s)</span>
<a name="l00125"></a>00125   SREG = tmp_sreg;
<a name="l00126"></a>00126   
<a name="l00127"></a>00127   <span class="keywordflow">return</span> key_mask;
<a name="l00128"></a>00128 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="31f3340ee7b1ffc380535d385834bdc4"></a><!-- doxytag: member="taste.c::get_key_rpt" ref="31f3340ee7b1ffc380535d385834bdc4" args="(char key_mask)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char get_key_rpt           </td>
          <td>(</td>
          <td class="paramtype">char&nbsp;</td>
          <td class="paramname"> <em>key_mask</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Überprüft, ob eine Taste lang genug betätigt worden ist, daß die tastenwiederholungs Funktion eintritt. Nach einer kleinen Verzögerung wird die gedrückte Taste regelmässig als erneut betätigt Makiert. Diese simuliert dem Benutzer ein wiederholendes drücken und loslassen der Taste. 
<p>
<dl compact><dt><b>Parameter:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>key_mask</em>&nbsp;</td><td>Maske der zu Überprüfenden Tasten.</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>RÃ¼ckgabe:</b></dt><dd>Wurde die Makierte Taste lange betätigt steht an entsprechender Stelle eine 1. </dd></dl>

<p>
Definiert in Zeile <a class="el" href="taste_8c-source.html#l00147">147</a> der Datei <a class="el" href="taste_8c-source.html">taste.c</a>.<div class="fragment"><pre class="fragment"><a name="l00148"></a>00148 {
<a name="l00149"></a>00149   uint8_t tmp_sreg;
<a name="l00150"></a>00150   tmp_sreg = SREG;
<a name="l00151"></a>00151   cli();
<a name="l00152"></a>00152   key_mask &amp;= <a class="code" href="taste_8c.html#a6d9a7a62a27dc6981cd6aeaf85a257c">key_rpt</a>;                          <span class="comment">// read key(s)</span>
<a name="l00153"></a>00153   <a class="code" href="taste_8c.html#a6d9a7a62a27dc6981cd6aeaf85a257c">key_rpt</a> ^= key_mask;                          <span class="comment">// clear key(s)</span>
<a name="l00154"></a>00154   SREG = tmp_sreg;
<a name="l00155"></a>00155   <span class="keywordflow">return</span> key_mask;
<a name="l00156"></a>00156 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="3c812199e970c6e24569b04f9a827c34"></a><!-- doxytag: member="taste.c::tasten" ref="3c812199e970c6e24569b04f9a827c34" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void tasten           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Tasten auf zusandswechsel überprüfen Die Funktion <a class="el" href="taste_8c.html#3c812199e970c6e24569b04f9a827c34" title="Tasten auf zusandswechsel überprüfen Die Funktion tasten() sollte etwas alle 4ms...">tasten()</a> sollte etwas alle 4ms aufgerufen werden. 
<p>
<dl class="user" compact><dt><b>Funktionsweise:</b></dt><dd>Alle Tasten am PORT KEY_INPUT, die nach viermaligem Aufruf den gleichen Zustand 0(LOW aktiv) haben, werden als key_press makiert.</dd></dl>
<dl compact><dt><b>Parameter:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>keine</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>RÃ¼ckgabe:</b></dt><dd>nichts </dd></dl>

<p>
Definiert in Zeile <a class="el" href="taste_8c-source.html#l00085">85</a> der Datei <a class="el" href="taste_8c-source.html">taste.c</a>.<div class="fragment"><pre class="fragment"><a name="l00086"></a>00086 {
<a name="l00087"></a>00087   <span class="keyword">static</span> <span class="keywordtype">char</span> ct0, ct1, rpt;
<a name="l00088"></a>00088   <span class="keywordtype">char</span> i;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090   i = <a class="code" href="taste_8c.html#5fb52792292a654fc6abd084c2af0065">key_state</a> ^ ~<a class="code" href="taste_8h.html#39ad97fe6026e517771b4a34d78f5712">KEY_INPUT</a>;   <span class="comment">// key changed ?</span>
<a name="l00091"></a>00091   ct0 = ~( ct0 &amp; i );                   <span class="comment">// reset or count ct0</span>
<a name="l00092"></a>00092   ct1 = (ct0 ^ ct1) &amp; i;                <span class="comment">// reset or count ct1</span>
<a name="l00093"></a>00093   i &amp;= ct0 &amp; ct1;                               <span class="comment">// count until roll over </span>
<a name="l00094"></a>00094   <a class="code" href="taste_8c.html#5fb52792292a654fc6abd084c2af0065">key_state</a> ^= i;                               <span class="comment">// then toggle debounced state</span>
<a name="l00095"></a>00095   <a class="code" href="taste_8c.html#3b45ef9bac4b1568ff5f0cf5183616d0">key_press</a> |= <a class="code" href="taste_8c.html#5fb52792292a654fc6abd084c2af0065">key_state</a> &amp; i;   <span class="comment">// 0-&gt;1: key pressing detect</span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097   <span class="keywordflow">if</span>( (<a class="code" href="taste_8c.html#5fb52792292a654fc6abd084c2af0065">key_state</a> &amp; <a class="code" href="taste_8h.html#2fddaac8cf9af7aa32c4001fa4ec7b4e">REPEAT_MASK</a>) == 0 )  <span class="comment">// check repeat function</span>
<a name="l00098"></a>00098     rpt = <a class="code" href="taste_8h.html#739044ea0313d14d019804ff5a41057d">REPEAT_START</a>;                 <span class="comment">// start delay</span>
<a name="l00099"></a>00099   <span class="keywordflow">if</span>( --rpt == 0 ){
<a name="l00100"></a>00100     rpt = <a class="code" href="taste_8h.html#c40940576c27fe63c124085a74d3a7ed">REPEAT_NEXT</a>;                  <span class="comment">// repeat delay</span>
<a name="l00101"></a>00101     <a class="code" href="taste_8c.html#a6d9a7a62a27dc6981cd6aeaf85a257c">key_rpt</a> |= <a class="code" href="taste_8c.html#5fb52792292a654fc6abd084c2af0065">key_state</a> &amp; REPEAT_MASK;
<a name="l00102"></a>00102   }
<a name="l00103"></a>00103 }
</pre></div>
<p>

</div>
</div><p>
<hr size="1"><address style="text-align: right;"><small>Erzeugt am Sun Apr 8 18:04:16 2007 fÃ¼r nBot von&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
